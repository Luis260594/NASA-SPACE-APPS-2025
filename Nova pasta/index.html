<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Green Cycle</title>
    <!-- IMPORTANT: The <script type="importmap"> block must be valid JSON.
       Do NOT add any comments (// or /* */), trailing commas, or other non‐JSON syntax inside it. -->
    <script type="importmap">
      {
        "imports": {
          "three": "https://esm.sh/three@0.163.0",
          "three/": "https://esm.sh/three@0.163.0/",
          "@dimforge/rapier3d-compat": "https://esm.sh/@dimforge/rapier3d-compat@0.17.3",
          "miniplex": "https://esm.sh/miniplex@2.0.0",
          "camera-controls": "https://esm.sh/camera-controls@2.10.1?external=three",
          "simplex-noise": "https://esm.sh/simplex-noise@4.0.1",
          "zustand/vanilla": "https://esm.sh/zustand@4.5.2/vanilla",
          "rosebud-threejs-game-engine": "./rosebud-threejs-game-engine.js"
        }
      }
    </script>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: #1a1a1a;
        font-family: "Arial", sans-serif;
      }
      canvas {
        display: block;
      }
      #renderDiv {
        width: 100vw;
        height: 100vh;
        position: absolute;
        top: 0;
        left: 0;
      }
      /* --- Game HUD Styles --- */
      #gameHud {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 100;
        display: flex;
        justify-content: space-between;
        padding: 20px;
        color: white;
        font-family: 'Segoe UI', 'Roboto', sans-serif;
        font-size: 18px;
        user-select: none;
        pointer-events: none;
        text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
      }
      #hud-left, #hud-right {
        pointer-events: all;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      #hud-right {
        align-items: flex-end;
      }
      .stat-item {
        background: rgba(0,0,0,0.4);
        padding: 8px 12px;
        border-radius: 6px;
        border: 1px solid rgba(255,255,255,0.15);
      }
      .stat-label { font-weight: 300; opacity: 0.8; margin-right: 8px; }
      .stat-value { font-weight: 600; }
      
      /* --- Satellite View Styles --- */
      #satelliteView {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0, 0, 0, 0.85);
        z-index: 200;
        display: none; /* Initially hidden */
        justify-content: center;
        align-items: center;
        flex-direction: column;
        color: white;
        font-family: 'Segoe UI', 'Roboto', sans-serif;
        backdrop-filter: blur(8px);
      }
      /* --- Game Cycle Modals --- */
      .game-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 300;
        display: none; /* Hidden by default */
        justify-content: center;
        align-items: center;
        color: white;
        font-family: 'Segoe UI', 'Roboto', sans-serif;
        backdrop-filter: blur(5px);
      }
      .modal-content {
        background: rgba(20, 20, 30, 0.9);
        padding: 30px 40px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        text-align: center;
        max-width: 500px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      }
      .modal-content.modal-wide {
        max-width: 800px;
      }
      .modal-content.modal-wide, .modal-content {
        max-height: 90vh;
        overflow-y: auto;
      }
      .modal-content h2 {
        margin-top: 0;
        font-size: 24px;
        color: #4a90e2;
      }
      .modal-content p {
        font-size: 16px;
        line-height: 1.6;
        opacity: 0.9;
        margin: 15px 0;
      }
      .final-stats {
          background: rgba(0,0,0,0.2);
          border-radius: 8px;
          padding: 15px;
          margin: 20px 0;
          border: 1px solid rgba(255,255,255,0.1);
      }
       .final-stats p {
           margin: 5px 0;
           font-size: 16px;
       }
      .modal-buttons {
        margin-top: 25px;
        display: flex;
        justify-content: center;
        gap: 15px;
      }
      .modal-button {
        padding: 12px 30px;
        font-size: 16px;
        cursor: pointer;
        border: 1px solid rgba(255, 255, 255, 0.4);
        border-radius: 8px;
        background-color: transparent;
        color: white;
        transition: background-color 0.2s, transform 0.2s;
      }
      .modal-button.primary {
        background-color: #3498db;
        border-color: #3498db;
      }
      .modal-button:hover {
        background-color: rgba(255, 255, 255, 0.15);
        transform: translateY(-2px);
      }
      .map-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      .map-toggle-btn {
        padding: 10px 25px;
        font-size: 16px;
        cursor: pointer;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        border-radius: 20px;
        transition: background-color 0.2s, color 0.2s;
      }
      .map-toggle-btn.active {
        background: #3498db;
        border-color: #3498db;
        color: #fff;
        font-weight: bold;
      }
      #map-panel {
        width: 60vw;
        height: 60vh;
        max-width: 800px;
        max-height: 600px;
        border: 2px solid rgba(255, 255, 255, 0.5);
        border-radius: 12px;
        position: relative;
        overflow: hidden;
        transition: background-color 0.7s ease-in-out;
        cursor: pointer;
      }
      #map-tooltip {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.7);
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        text-align: center;
        max-width: 80%;
        opacity: 1;
        transition: opacity 0.3s;
        pointer-events: none;
      }
      #closeSatelliteView {
        margin-top: 30px;
        padding: 12px 25px;
        font-size: 16px;
        cursor: pointer;
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.5);
        color: white;
        border-radius: 5px;
      }
      /* Button to open satellite view */
      #toggleSatelliteViewBtn {
        position: fixed;
        top: 140px;
        right: 20px;
        z-index: 101;
        width: 60px;
        height: 60px;
        cursor: pointer;
        background: rgba(0, 0, 0, 0.5) url('https://play.rosebud.ai/assets/satellite-icon.png?gA6U') no-repeat center center;
        background-size: 60%;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        font-family: 'Segoe UI', 'Roboto', sans-serif;
        transition: transform 0.2s, background-color 0.2s, box-shadow 0.2s;
        pointer-events: all;
        box-shadow: 0 0 0 0 rgba(74, 144, 226, 0.4);
        animation: pulse-satellite 2s infinite;
      }
      #toggleSatelliteViewBtn:hover {
        transform: scale(1.1);
        background-color: rgba(0, 0, 0, 0.7);
        animation: none;
      }
      #toggleSatelliteViewBtn::after {
        content: '📊';
        position: absolute;
        bottom: -8px;
        right: -8px;
        font-size: 18px;
        background: rgba(74, 144, 226, 0.9);
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid white;
      }
      #toggleUpgradesBtn {
        position: fixed;
        top: 140px;
        right: 100px;
        z-index: 101;
        width: 60px;
        height: 60px;
        cursor: pointer;
        background: rgba(0, 0, 0, 0.5) url('https://play.rosebud.ai/assets/upgrade-icon.png?qA7V') no-repeat center center;
        background-size: 60%;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        transition: transform 0.2s, background-color 0.2s, box-shadow 0.2s;
        pointer-events: all;
        box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.4);
        animation: pulse-upgrades 2s infinite;
      }
       #toggleUpgradesBtn:hover {
        transform: scale(1.1);
        background-color: rgba(0, 0, 0, 0.7);
        animation: none;
      }
      #toggleUpgradesBtn::after {
        content: '🔧';
        position: absolute;
        bottom: -8px;
        right: -8px;
        font-size: 18px;
        background: rgba(39, 174, 96, 0.9);
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid white;
      }
      @keyframes pulse-satellite {
        0% {
          box-shadow: 0 0 0 0 rgba(74, 144, 226, 0.4);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(74, 144, 226, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(74, 144, 226, 0);
        }
      }
      @keyframes pulse-upgrades {
        0% {
          box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.4);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(39, 174, 96, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(39, 174, 96, 0);
        }
      }
      .upgrade-item {
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
        text-align: left;
      }
      .upgrade-item h3 { margin: 0 0 10px; color: #5dade2; }
      .upgrade-item p { margin: 0 0 15px; opacity: 0.8; font-size: 14px; }
      .upgrade-footer { display: flex; justify-content: space-between; align-items: center; }
      .upgrade-cost { font-weight: bold; font-size: 16px; }
      .upgrade-button {
          background-color: #27ae60;
          border-color: #27ae60;
      }
      .upgrade-button:disabled {
          background-color: #555;
          border-color: #555;
          cursor: not-allowed;
      }
      #map-panel-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
        width: 100%;
        height: 100%;
        gap: 5px;
        padding: 5px;
        box-sizing: border-box;
      }
      .map-plot {
        background-color: #333;
        border-radius: 5px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 18px;
        font-weight: bold;
        position: relative;
        transition: background-color 0.7s ease-in-out;
      }
      .map-plot::before {
        content: 'Plot ' attr(data-plot-id);
        position: absolute;
        top: 10px;
        left: 10px;
        font-size: 14px;
        font-weight: normal;
        color: rgba(255, 255, 255, 0.8);
        text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
      }
       .decision-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
        width: 100%;
      }
      .decision-lot {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        transition: background-color 0.2s, border-color 0.2s;
      }
       .decision-lot.decided {
        background: rgba(40, 180, 99, 0.15);
        border-color: rgba(40, 180, 99, 0.4);
      }
      .decision-lot h4 {
          margin: 0 0 5px;
          color: #5dade2;
      }
      .decision-lot p {
          margin: 0 0 15px;
          font-size: 14px;
          opacity: 0.8;
      }
      .decision-lot-buttons {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 10px;
      }
      .action-card {
        background: rgba(0,0,0,0.2);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 8px;
        padding: 12px;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        text-align: left;
      }
      .action-card:hover {
        background: rgba(74, 144, 226, 0.2);
        border-color: rgba(74, 144, 226, 0.5);
        transform: translateY(-2px);
      }
      .action-card h5 {
        margin: 0 0 5px;
        font-size: 15px;
        color: #fff;
      }
      .action-card .action-game-effect {
        font-size: 13px;
        opacity: 0.8;
        margin: 0 0 8px;
        font-style: italic;
      }
      .action-card .action-sustainability-info {
        font-size: 12px;
        line-height: 1.5;
        opacity: 0.7;
        border-left: 2px solid rgba(255, 255, 255, 0.3);
        padding-left: 8px;
        margin: 0;
      }
      .decision-lot-buttons .modal-button.secondary {
          grid-column: 1 / -1; /* Span full width */
          background-color: transparent;
          border-color: #777;
      }
      .decision-lot-buttons .modal-button {
          padding: 8px 12px;
          font-size: 14px;
          flex: 1;
      }
       #proceedBtn {
          margin-top: 25px;
          display: none; /* Hidden until all decisions are made */
      }
      /* --- Responsive Design for Modals --- */
      @media (max-width: 850px) {
        .modal-content {
          width: 90vw;
          padding: 20px;
        }
        .modal-content h2 {
          font-size: 20px;
        }
        .modal-content p {
          font-size: 14px;
        }
        .decision-container {
          grid-template-columns: 1fr;
          gap: 15px;
        }
        .action-card h5 {
          font-size: 14px;
        }
        .action-card .action-game-effect {
          font-size: 12px;
        }
        .action-card .action-sustainability-info {
          font-size: 11px;
        }
      }
      @media (max-width: 600px) {
        #hud-left, #hud-right {
            gap: 5px;
        }
        .stat-item {
            padding: 6px 10px;
            font-size: 14px;
        }
        #toggleSatelliteViewBtn, #toggleUpgradesBtn {
          width: 50px;
          height: 50px;
          top: 120px;
        }
        #startHarvestBtn {
          padding: 10px 20px;
          font-size: 14px;
        }
      }
    </style>
  </head>
  <body>
    <canvas id="game-canvas"></canvas>
    <!-- UI containers -->
    <div id="uiContainer">
        <div id="gameHud">
          <!-- HUD content is generated by gameStatsUI.js -->
        </div>
        <button id="toggleSatelliteViewBtn" title="Open Satellite View"></button>
        <button id="toggleUpgradesBtn" title="Open Upgrades"></button>
        <div id="satelliteView">
          <div class="map-controls">
            <button class="map-toggle-btn active" id="toggle-ndvi">NDVI</button>
            <button class="map-toggle-btn" id="toggle-lst">LST</button>
          </div>
          <div id="map-panel">
              <div id="map-panel-grid">
                  <div class="map-plot" data-plot-id="1"></div>
                  <div class="map-plot" data-plot-id="2"></div>
                  <div class="map-plot" data-plot-id="3"></div>
                  <div class="map-plot" data-plot-id="4"></div>
              </div>
              <div id="map-tooltip"></div>
          </div>
          <button id="closeSatelliteView">Close</button>
        </div>
        <!-- Introduction Screen -->
        <div id="introScreen" class="game-modal" style="display: flex;">
            <div class="modal-content">
                <h2 style="font-size: 32px; margin-bottom: 15px;">Green Cycle: Sugarcane</h2>
                <p style="margin-bottom: 25px; font-style: italic;">A sustainable farming simulation</p>
                
                <div style="text-align: left; margin: 20px 0;">
                    <h3 style="color: #4a90e2; margin-bottom: 10px;">About This Game</h3>
                    <p style="line-height: 1.8;">
                        Manage a sugarcane farm over 5 years while balancing productivity and sustainability. 
                        Make strategic decisions about planting, irrigation, and soil management to achieve the perfect balance.
                    </p>
                </div>
                
                <div style="text-align: left; margin: 20px 0;">
                    <h3 style="color: #4a90e2; margin-bottom: 10px;">Controls</h3>
                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                        <div style="display: grid; grid-template-columns: auto 1fr; gap: 12px; align-items: center;">
                            <strong style="color: #5dade2;">WASD:</strong>
                            <span style="opacity: 0.9;">Move around the farm</span>
                            
                            <strong style="color: #5dade2;">Mouse:</strong>
                            <span style="opacity: 0.9;">Look around and rotate camera</span>
                            
                            <strong style="color: #5dade2;">Shift:</strong>
                            <span style="opacity: 0.9;">Hold to run</span>
                            
                            <strong style="color: #5dade2;">Space:</strong>
                            <span style="opacity: 0.9;">Jump</span>
                            
                            <strong style="color: #5dade2;">Mouse Wheel:</strong>
                            <span style="opacity: 0.9;">Zoom in/out</span>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: left; margin: 20px 0;">
                    <h3 style="color: #4a90e2; margin-bottom: 10px;">Key Metrics</h3>
                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                        <h4 style="color: #5dade2; margin: 0 0 8px;">NDVI (Vegetation Health)</h4>
                        <p style="margin: 0; opacity: 0.9; line-height: 1.6;">
                            The Normalized Difference Vegetation Index measures crop health and density. 
                            Higher values (closer to 1.0) indicate healthier, more productive crops.
                        </p>
                    </div>
                    <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px;">
                        <h4 style="color: #e74c3c; margin: 0 0 8px;">LST (Surface Temperature)</h4>
                        <p style="margin: 0; opacity: 0.9; line-height: 1.6;">
                            Land Surface Temperature indicates heat stress on crops. 
                            Lower temperatures (below 34°C) mean better growing conditions and less water stress.
                        </p>
                    </div>
                </div>
                
                <div class="modal-buttons">
                    <button id="startGameBtn" class="modal-button primary" style="font-size: 18px; padding: 15px 40px;">Start Game</button>
                </div>
            </div>
        </div>
        <!-- Game Cycle Modals -->
        <div id="preSeasonScreen" class="game-modal">
            <div class="modal-content modal-wide">
                <h2 id="preSeasonTitle">Year 1 - Planning Phase</h2>
                <p id="preSeasonText">Decide which lots to plant.</p>
                <div id="preSeasonDecisionContainer" class="decision-container">
                    <!-- Pre-season lot decision cards will be generated here -->
                </div>
                <!-- This button is now handled by the mainActionButton -->
                <button id="startGrowingBtn" class="modal-button primary" style="display: none;">Start Growing Season</button>
            </div>
        </div>
        <!-- This button is now handled by the mainActionButton -->
        <button id="startHarvestBtn" class="modal-button primary" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 101; display: none;">Start Harvest</button>
        
        <!-- Unified Main Action Button -->
        <button id="mainActionButton" class="modal-button primary" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 301; display: none; padding: 12px 30px; font-size: 16px;"></button>
        <div id="postHarvestScreen" class="game-modal">
             <div class="modal-content modal-wide">
                <h2 id="postHarvestTitle">Year 1 - Harvest</h2>
                <p id="postHarvestText">The harvest is complete.</p>
                <p>Manage the straw residue for each lot to prepare for the next season.</p>
                <div id="decision-container" class="decision-container">
                    <!-- Lot decision cards will be generated by gameCycleUI.js -->
                </div>
                 <!-- This button is now handled by the mainActionButton -->
                 <button id="proceedBtn" class="modal-button primary" style="display: none;">Proceed to Next Year</button>
            </div>
        </div>
        <div id="upgradesScreen" class="game-modal">
            <div class="modal-content">
                <h2>Farm Upgrades</h2>
                <p style="opacity: 0.8; margin-bottom: 20px;">Invest in technology to improve your farm's productivity and sustainability.</p>
                
                <div class="upgrade-item" id="upgrade-soil-sensors">
                    <h3>Advanced Soil Sensors</h3>
                    <p>Install sensors in the field that provide more accurate data, resulting in a passive bonus of <strong>+0.02 to your NDVI</strong> each year.</p>
                    <div style="background: rgba(40, 180, 99, 0.1); padding: 10px; border-radius: 5px; margin: 10px 0; border-left: 3px solid #28b463;">
                        <small style="opacity: 0.9;">🌱 <strong>Impact:</strong> Better crop monitoring leads to healthier, denser vegetation throughout the growing season.</small>
                    </div>
                    <div class="upgrade-footer">
                        <span class="upgrade-cost">Cost: $15,000</span>
                        <button id="buySoilSensorsBtn" class="modal-button upgrade-button">Buy</button>
                    </div>
                </div>
                
                <div class="upgrade-item" id="upgrade-irrigation">
                    <h3>Precision Irrigation System</h3>
                    <p>An intelligent irrigation system that combats water stress, reducing the base LST by <strong>2°C</strong> each year.</p>
                    <div style="background: rgba(52, 152, 219, 0.1); padding: 10px; border-radius: 5px; margin: 10px 0; border-left: 3px solid #3498db;">
                        <small style="opacity: 0.9;">💧 <strong>Impact:</strong> Optimized water delivery keeps crops cool and hydrated, preventing heat stress and improving yields.</small>
                    </div>
                    <div class="upgrade-footer">
                        <span class="upgrade-cost">Cost: $30,000</span>
                        <button id="buyIrrigationBtn" class="modal-button upgrade-button">Buy</button>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button id="closeUpgradesBtn" class="modal-button">Close</button>
                </div>
            </div>
        </div>
        <div id="winScreen" class="game-modal">
            <div class="modal-content">
                <h2>Sustainable Farm!</h2>
                <p>Congratulations! You've successfully managed your farm by maintaining an average NDVI above 0.70 and an average LST below 34°C for 3 consecutive years.</p>
                <p><strong>You have won the game!</strong></p>
                <div class="modal-buttons">
                    <button id="restartGameBtn" class="modal-button primary">Play Again</button>
                </div>
            </div>
        </div>
        <div id="endScreen" class="game-modal">
            <div class="modal-content">
                <h2>Cycle Complete</h2>
                <p>You have completed the 5-year cycle. Here is your final report:</p>
                <div class="final-stats">
                    <p><strong>Final Money:</strong> <span id="end-final-money">$0.00</span></p>
                    <p><strong>Final Year:</strong> <span id="end-final-year">2024</span></p>
                </div>
                <p>Can you achieve a fully sustainable farm next time?</p>
                <div class="modal-buttons">
                    <button id="restartGameBtnEnd" class="modal-button primary">Play Again</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Background Music -->
    <audio id="backgroundMusic" loop>
      <source src="https://play.rosebud.ai/assets/AUDIO-2025-10-04-20-53-55.mp3?FwJY" type="audio/mpeg">
    </audio>
    <!-- Engine entrypoint -->
    <script type="module" src="main.js"></script>
    <!-- Rosebud platform scripts -->
    <script src="https://storage.googleapis.com/rosebud_staticfiles/ChatManager.js"></script>
    <script src="https://storage.googleapis.com/rosebud_staticfiles/ImageGenerator.js"></script>
    <script src="https://storage.googleapis.com/rosebud_staticfiles/ProgressLogger.js"></script>
    <script src="https://storage.googleapis.com/rosebud_staticfiles/OGP.js"></script>
  </body>
</html>